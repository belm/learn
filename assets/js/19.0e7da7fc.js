(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{374:function(e,n,a){"use strict";a.r(n);var t=a(45),s=Object(t.a)({},(function(){var e=this,n=e.$createElement,a=e._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"k8s"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s"}},[e._v("#")]),e._v(" K8s")]),e._v(" "),a("h2",{attrs:{id:"pod声明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pod声明"}},[e._v("#")]),e._v(" pod声明")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("元数据(metadata): namespace(命名空间)，name（对象名），uid（对象ID）, 标签（lables），注释（annotations）")])]),e._v(" "),a("li",[a("p",[e._v("规范（spec） 描述了该对象的详细配置信息，即用户希望的状态")])]),e._v(" "),a("li",[a("p",[e._v("状态（status）  包含了该对象的一些状态信息，会由各个控制器定期进行更新")])])]),e._v(" "),a("p",[e._v("环境搭建：")]),e._v(" "),a("p",[e._v("https://www.katacoda.com/courses/kubernetes/playground")]),e._v(" "),a("p",[e._v("namespace")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v(" 一组资源和对象的抽象集合，内置的namespace: default, kube-system, kube-public, kube-node-lease\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('apiVersion: v1 #指定当前描述文件遵循v1版本的Kubernetes API\nkind: Pod #我们在描述一个pod\nmetadata:\n  name: twocontainers #指定pod的名称\n  namespace: default #指定当前描述的pod所在的命名空间\n  labels: #指定pod标签\n    app: twocontainers\n  annotations: #指定pod注释\n    version: v0.5.0\n    releasedBy: david\n    purpose: demo\nspec:\n  containers:\n  - name: sise #容器的名称\n    image: quay.io/openshiftlabs/simpleservice:0.5.0 #创建容器所使用的镜像\n    ports:\n    - containerPort: 9876 #应用监听的端口\n  - name: shell #容器的名称\n    image: centos:7 #创建容器所使用的镜像\n    command: #容器启动命令\n      - "bin/bash"\n      - "-c"\n      - "sleep 10000"\n')])])]),a("h3",{attrs:{id:"创建pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建pod"}},[e._v("#")]),e._v(" 创建pod")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl create -f ./twocontainers.yaml\nkubectl get pods\nkubectl get pod twocontainers -o=jsonpath='{.status.phase}'\nkubectl exec twocontainers -c shell -it -- bash\n进入容器后执行\ncurl -s localhost:9876/info\n\nkubectl describe pod twocontainers\n")])])]),a("h3",{attrs:{id:"pod-的重启策略-spec-restartpolicy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pod-的重启策略-spec-restartpolicy"}},[e._v("#")]),e._v(" Pod 的重启策略  spec.restartPolicy")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("Always   表示一直重启，这也是默认的重启策略\nOnFailure  表示只有在容器异常退出，即退出码不为 0 时，才会对其进行重启操作\nNever  表示从不重启；\n")])])]),a("h3",{attrs:{id:"pod-中的健康检查-针对容器-spec-containers-xxx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pod-中的健康检查-针对容器-spec-containers-xxx"}},[e._v("#")]),e._v(" Pod 中的健康检查(针对容器) spec.containers.xxx")]),e._v(" "),a("ul",[a("li",[e._v("livenessProbe 可以用来探测容器是否真的在“运行”，即“探活”(探活检测)")]),e._v(" "),a("li",[e._v("readinessProbe  常常用于指示容器是否可以对外提供正常的服务请求，即“就绪”(就绪监测)")]),e._v(" "),a("li",[e._v("startupProbe  则可以用于判断容器是否已经启动好")])]),e._v(" "),a("p",[e._v("Probe 内置了如下三个 Handler：")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://kubernetes.io/docs/resources-reference/v1.7/#execaction-v1-core",target:"_blank",rel:"noopener noreferrer"}},[e._v("ExecAction"),a("OutboundLink")],1),e._v(" 可以在容器内执行 shell 脚本；")]),e._v(" "),a("li",[a("a",{attrs:{href:"https://kubernetes.io/docs/resources-reference/v1.7/#httpgetaction-v1-core",target:"_blank",rel:"noopener noreferrer"}},[e._v("HTTPGetAction"),a("OutboundLink")],1),e._v(" 方便对指定的端口和 IP 地址执行 HTTP Get 请求；")]),e._v(" "),a("li",[a("a",{attrs:{href:"https://kubernetes.io/docs/resources-reference/v1.7/#tcpsocketaction-v1-core",target:"_blank",rel:"noopener noreferrer"}},[e._v("TCPSocketAction"),a("OutboundLink")],1),e._v(" 可以对指定端口进行 TCP 检查；")])]),e._v(" "),a("p",[e._v("在这里 Probe 还提供了其他配置字段，比如 failureThreshold （失败阈值）等，你可以到"),a("a",{attrs:{href:"https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes",target:"_blank",rel:"noopener noreferrer"}},[e._v("这个官方文档"),a("OutboundLink")],1),e._v("中查看更详细的解释。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("对于每一种 Probe，Kubelet 只会执行其中一种 Handler。如果你定义了多个 Handler，则会按照 Exec、HTTPGet、TCPSocket 的优先级顺序，选择第一个定义的 Handler。\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("apiVersion: v1\nkind: Pod\nmetadata:\n  name: probe-demo\n  namespace: demo\nspec:\n  containers:\n  - name: sise\n    image: quay.io/openshiftlabs/simpleservice:0.5.0\n    ports:\n    - containerPort: 9876\n    readinessProbe:\n      tcpSocket:\n        port: 9876\n      periodSeconds: 10\n    livenessProbe:\n      periodSeconds: 5\n      httpGet:\n        path: /health\n        port: 9876\n    startupProbe:\n      httpGet:\n        path: /health\n        port: 9876\n      failureThreshold: 3\n      periodSeconds: 2\n")])])]),a("h3",{attrs:{id:"容器生命周期内的-hook"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#容器生命周期内的-hook"}},[e._v("#")]),e._v(" 容器生命周期内的 hook")]),e._v(" "),a("ul",[a("li",[e._v("PostStart 可以在容器启动之后就执行")]),e._v(" "),a("li",[e._v("PreStop 则在容器被终止之前被执行，是一种阻塞式的方式。执行完成后，Kubelet 才真正开始销毁容器。")])]),e._v(" "),a("p",[e._v("同上面的 Probe 一样，hook 也有类似的 Handler：")]),e._v(" "),a("ul",[a("li",[e._v("Exec 用来执行 Shell 命令；")]),e._v(" "),a("li",[e._v("HTTPGet 可以执行 HTTP 请求。")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('apiVersion: v1\nkind: Pod\nmetadata:\n  name: lifecycle-demo\n  namespace: demo\nspec:\n  containers:\n  - name: lifecycle-demo-container\n    image: nginx:1.19\n    lifecycle:\n      postStart:\n        exec:\n          command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]\n      preStop:\n        exec:\n          command: ["/usr/sbin/nginx","-s","quit"]\n')])])]),a("h3",{attrs:{id:"init-容器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#init-容器"}},[e._v("#")]),e._v(" init 容器")]),e._v(" "),a("p",[e._v("应用容器专注于业务处理，其他一些无关的初始化任务就可以放到 init 容器中。这种解耦有利于各自升级，也降低相互依赖。")]),e._v(" "),a("p",[e._v("一个 Pod 中允许有一个或多个 init 容器。init 容器和其他一般的容器非常像，其与众不同的特点主要有：")]),e._v(" "),a("ul",[a("li",[e._v("总是运行到完成，可以理解为一次性的任务，不可以运行常驻型任务，因为会 block 应用容器的启动运行；")]),e._v(" "),a("li",[e._v("顺序启动执行，下一个的 init 容器都必须在上一个运行成功后才可以启动；")]),e._v(" "),a("li",[e._v("禁止使用 readiness/liveness 探针，可以使用 Pod 定义的"),a("strong",[e._v("activeDeadlineSeconds")]),e._v("，这其中包含了 Init Container 的启动时间；")]),e._v(" "),a("li",[e._v("禁止使用 lifecycle hook。")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("apiVersion: v1\nkind: Pod\nmetadata:\n  name: myapp-pod\n  namespace: demo\n  labels:\n    app: myapp\nspec:\n  containers:\n  - name: myapp-container\n    image: busybox:1.31\n    command: [‘sh’, ‘-c’, ‘echo The app is running! && sleep 3600‘]\n  initContainers:\n  - name: init-myservice\n    image: busybox:1.31\n    command: ['sh', '-c', 'until nslookup myservice; do echo waiting for myservice; sleep 2; done;']\n  - name: init-mydb\n    image: busybox:1.31\n    command: ['sh', '-c', 'until nslookup mydb; do echo waiting for mydb; sleep 2; done;']\n")])])]),a("p",[e._v("在 myapp-container 启动之前，它会依次启动 init-myservice、init-mydb，分别来检查依赖的服务是否可用。")])])}),[],!1,null,null,null);n.default=s.exports}}]);